"use strict";var $=Object.create;var h=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var X=(o,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of B(s))!Q.call(o,r)&&r!==e&&h(o,r,{get:()=>s[r],enumerable:!(t=z(s,r))||t.enumerable});return o};var a=(o,s,e)=>(e=o!=null?$(G(o)):{},X(s||!o||!o.__esModule?h(e,"default",{value:o,enumerable:!0}):e,o));var L=require("dotenv"),w=a(require("express")),J=a(require("cors"));var b=a(require("express"));var y=a(require("jsonwebtoken")),C=(o,s,e)=>{let t=o.headers.authorization;if(!t)return s.sendStatus(403);y.default.verify(t,process.env.ACCESS_TOKEN_SECRET,r=>{if(console.log(r),r)return s.sendStatus(403);e()})};var E=require("@prisma/client"),n;global.__db||(global.__db=new E.PrismaClient);n=global.__db;var S=async(o,s)=>{let{completed:e,title:t=""}=o.body;if(!t.trim())return s.status(400).json({message:"Title is required!"});try{return await n.todo.create({data:{title:t,completed:e}}),s.status(200).json({message:"Todo added successfully!"})}catch(r){if(r instanceof Error)return s.status(400).json({message:"Error!",description:"Something went wrong while adding todo."})}};var j=async(o,s)=>{let e=await n.todo.findMany({orderBy:{createdAt:"desc"}});s.status(200).json(e)};var x=async(o,s)=>{let{id:e}=o.body;if(!e)return s.status(400).json({message:"No id provided!"});try{await n.todo.delete({where:{id:e}}),s.status(200).json({message:"Todo deleted successfully!"})}catch(t){t instanceof Error&&s.status(400).json({message:"Something went wrong while deleting todo!"})}};var q=async(o,s)=>{let{title:e,completed:t,id:r}=o.body;if(!r)return s.status(400).json({message:"No id provided!"});if(!e.trim())return s.status(400).json({message:"Title is required!"});try{await n.todo.update({data:{title:e,completed:t},where:{id:r}}),s.status(200).json({message:"Todo Edited successfully!"})}catch(i){i instanceof Error&&s.status(400).json({message:"Something went wrong while editing todo!"})}};var _=async(o,s)=>{let e=+o.params.id;if(!e)return s.status(400).json({message:"No id provided!"});let t=await n.todo.findUnique({where:{id:e}});s.status(200).json(t)};var g=b.default.Router();g.use(C);g.route("/").post(S).get(j).delete(x).patch(q);g.route("/:id").get(_);var k=g;var v={origin:"http://localhost:3000",credentials:!0,optionsSuccessStatus:200};var M=a(require("cookie-parser"));var H=a(require("express"));var N=require("express-rate-limit"),O=(0,N.rateLimit)({windowMs:60*1e3,max:5,message:{message:"Too many login attempts!",description:"Too many login attempts from this IP, please try again after a 30 second pause"},handler:(o,s,e,t)=>{s.status(t.statusCode).send(t.message)},standardHeaders:!0,legacyHeaders:!1});var I=require("bcrypt"),l=a(require("jsonwebtoken")),Y=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i,P=async(o,s)=>{let{name:e,email:t,password:r}=o.body;if(!e.trim())return s.status(400).json({message:"Name is required!"});if(!Y.test(t))return s.status(400).json({message:"Thats not an email!"});if(!r.trim()||r.length<8)return s.status(400).json({message:"Error!",description:"Password should contain atleast 8 characters"});try{if(await n.user.findFirst({where:{email:t}}))return s.status(400).json({message:"Error!",description:"Account with this email already exists!"});let m=(0,I.hashSync)(r,12),d=await n.user.create({data:{name:e,email:t,password:m}}),{password:f,...p}=d,V=l.default.sign(p,process.env.ACCESS_TOKEN_SECRET,{expiresIn:"60d"}),W=l.default.sign(p,process.env.REFRESH_TOKEN_SECRET,{expiresIn:"90d"});s.cookie("jwt",W,{httpOnly:!0,secure:!0,sameSite:"none",maxAge:7776e3}),s.json({token:V,user:p,message:"Success!",description:"Created account successfully!"})}catch(i){i instanceof Error&&s.status(400).json({message:"Something went wrong. Try again later!"})}};var A=require("bcrypt"),R=a(require("jsonwebtoken")),Z=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i,F=async(o,s)=>{let{email:e,password:t}=o.body;if(!Z.test(e))return s.status(400).json({message:"Thats not an email!"});if(!t.trim()||t.length<8)return s.status(400).json({message:"Error!",description:"Password should contain at least 8 characters"});try{let r=await n.user.findFirst({where:{email:e}});if(!r)return s.status(400).json({message:"Error!",description:"Credentials are invalid!"});let{password:i,...m}=r;if(!(0,A.compareSync)(t,i))return s.status(400).json({message:"Error!",description:"Credentials are invalid!"});let f=R.default.sign(m,process.env.ACCESS_TOKEN_SECRET,{expiresIn:"60d"}),p=R.default.sign(m,process.env.REFRESH_TOKEN_SECRET,{expiresIn:"90d"});s.cookie("jwt",p,{httpOnly:!0,secure:!0,sameSite:"none",maxAge:7776e3}),s.json({token:f,user:m,message:"Success!",description:"Signed in successfully!"})}catch(r){r instanceof Error&&s.status(400).json({message:"Something went wrong. Try again later!"})}};var T=a(require("jsonwebtoken"));var U=async(o,s)=>{let e=o.cookies.jwt;if(!e)return s.sendStatus(401);T.default.verify(e,process.env.REFRESH_TOKEN_SECRET,async(t,r)=>{if(t){s.sendStatus(401);return}let i=await n.user.findFirst({where:{email:r.email}});if(!i)return s.sendStatus(401);let{password:m,...d}=i,f=T.default.sign({email:d.email},process.env.ACCESS_TOKEN_SECRET,{expiresIn:"60d"});s.status(200).json({token:f,user:d})})};var K=async(o,s)=>{console.log("hejcia"),s.clearCookie("jwt",{httpOnly:!0,secure:!0,sameSite:"none"}),s.json({message:"Signed out!"})};var c=H.default.Router();c.route("/signup").post(P);c.route("/signin").post(O,F);c.route("/refresh").get(U);c.route("/signout").get(K);var D=c;(0,L.config)();var u=(0,w.default)();u.use((0,J.default)(v));u.use((0,M.default)());u.use(w.default.json());u.use("/todo",k);u.use("/",D);u.listen(process.env.PORT);
//# sourceMappingURL=index.js.map
